<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
</head>
<body>
    <h1>WebSocket Client</h1>
    <input id="inputField" type="text" placeholder="Type your message here" />
    <button onclick="sendMessage()">Send</button>
    <button onclick="changeLocale()">Change Locale</button>
    <p id="response"></p>

    <script>
        const botName = "marboris";
        const socket = new WebSocket("ws://localhost:8080/websocket");
        let userToken = generateToken();
        let userLocale = "en";

        // WebSocket connection opened
        socket.onopen = function(event) {
            console.log("WebSocket is connected");
            handshake();
        };

        // WebSocket message received
        socket.onmessage = function(event) {
            let responseMessage = JSON.parse(event.data);
            document.getElementById("response").innerText = `${botName}> ${responseMessage.content}`;
        };

        // WebSocket error
        socket.onerror = function(error) {
            console.error("WebSocket Error:", error);
        };

        // WebSocket closed
        socket.onclose = function(event) {
            console.log("WebSocket is closed now.");
        };

        // Function to send handshake message
        function handshake() {
            const handshakeMessage = {
                type: 0,
                information: {},
                user_token: userToken,
            };
            socket.send(JSON.stringify(handshakeMessage));
        }

        // Function to send message
        function sendMessage() {
            const inputField = document.getElementById("inputField");
            const content = inputField.value.trim();

            if (content === "/quit") {
                socket.close();
            } else if (content.startsWith("/lang ")) {
                const parts = content.split(" ");
                if (parts.length === 2) {
                    userLocale = parts[1];
                    console.log(`Language changed to ${userLocale}`);
                } else {
                    console.log("Usage: /lang <locale>");
                }
            } else if (content !== "") {
                const message = {
                    type: 1,
                    content: content,
                    user_token: userToken,
                    information: {},
                    locale: userLocale,
                };
                socket.send(JSON.stringify(message));
                inputField.value = '';
            } else {
                console.log("Please enter a message");
            }
        }

        // Function to generate a random token
        function generateToken() {
            let array = new Uint8Array(50);
            window.crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, "0")).join("");
        }

        // Function to change locale
        function changeLocale() {
            const newLocale = prompt("Enter new locale (e.g., en, fr, es):");
            if (newLocale) {
                userLocale = newLocale;
                console.log(`Locale changed to: ${userLocale}`);
            }
        }
    </script>
</body>
</html>
